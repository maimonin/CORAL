# Vulnerability Handler


## Purpose

The Vulnerability Handler module is designed to manage and analyze vulnerabilities within containerized environments. It leverages tools like Trivy for scanning and parsing vulnerability data to provide actionable insights. 
This module automates the process of scanning a Kubernetes cluster for vulnerabilities, parsing the results, and generating readable outputs for analysis and mitigation.

The Vulnerability Handler collects data about vulnerabilities in the Kubernetes cluster in two steps:
1. Scan cluster for vulnerabilities using Trivy and save report as JSON.
2. Parse JSON report file and create appropriate CSV vulnerabilities data file.


## Features

* **Trivy Integration**: Uses Trivy for comprehensive vulnerability scanning of Kubernetes clusters. 
* **JSON Parsing**: Converts Trivy JSON output into a structured CSV format. 
* **CVE Analysis**: Categorizes vulnerabilities by severity and aggregates CVE data for each pod. 
* **Automated Reporting**: Outputs both detailed and summary reports for vulnerability analysis.


## Architecture

### `cve_count_creator.py`
A Python script to count and categorize Common Vulnerabilities and Exposures (CVEs) based on their severity and occurrence.

### `trivy_parser.py`
A Python script to parse JSON output from Trivy scans into a more readable and actionable format.
The script reads Trivy's scan report JSON file as a Python dictionary and parse it to create relevant data in CSV output.


## Prerequisites

- Python 3.8+
  - Pandas library for data processing.
- Kubernetes cluster access with `kubectl` configured.
- Trivy installed and configured.
  - Permissions to execute Trivy scans.
  - For more information about Trivy, see the 'Trivy' section below.


## Directory Structure

```
.
|-- cve_count_creator.py
|-- trivy_parser.py
|-- Trivy
    |-- trivy_vuln_scan.json
```

### `/Trivy`

This subdirectory contains resources related to Trivy, including its scan outputs.
- `Trivy/trivy_vuln_scan.json`: Sample JSON output from a Trivy vulnerability scan. This file serves as a reference or template for Trivy scan data.


## Usage

1. Run Trivy to scan your containerized application or image:
   ```
   trivy image <image-name> -f json -o Trivy/trivy_vuln_scan.json
   ```
   
2. Parse the scan results using the `trivy_parser.py` script.

3. Analyze the CVE counts using the `cve_count_creator.py` script.

### Output

* **The Trivy Parser output** contains the following fields:
  * Name
  * PkgName
  * InstalledVersion
  * VulernabilityID
  * Severity
  * Title
  * CVSS

* **The module outputs:**
  - Parsed CVE data in an easy-to-read format.
  - Summaries of vulnerabilities categorized by severity.


---


## Trivy

- Trivy is a comprehensive and versatile security scanner.
- Trivy has *scanners* that look for security issues, and *targets* where it can find those issues.
- Trivyâ€™s CVEs DB is updated from time to time.
- More information about Trivy: [Trivy GitHub Repository](https://github.com/aquasecurity/trivy)


### Trivy Features

* Targets (what Trivy can scan):
  - Container Image
  - Filesystem
  - Git Repository (remote)
  - Virtual Machine Image
  - Kubernetes
  - AWS

* Scanners (what Trivy can find there):
  - OS packages and software dependencies in use (SBOM)
  - Known vulnerabilities (CVEs)
  - IaC issues and misconfigurations
  - Sensitive information and secrets
  - Software licenses


### Trivy Usage 

* In the **CORAL framework**, Trivy is used to:
  * Scan Kubernetes cluster for security issues and generate security reports.
  * Scan a full cluster and generate a simple summary report.
  * Get all the detail the output contains.
  * Filter by security check (Vulnerabilities).


* **Trivy CLI command:** 
  * ``` trivy k8s -n attack-graphs --report summary all --security-checks vuln --format json >> trivy_vuln_scan.json ```

    
* **Output**: JSON file of a full cluster scan.


---


## References

* [Trivy GitHub Repository](https://github.com/aquasecurity/trivy)
